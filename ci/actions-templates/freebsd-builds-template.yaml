# This is ci/actions-templates/freebsd-builds-template.yaml
# Do not edit this file in .github/workflows

name: FreeBSD (PR) # skip-master skip-stable
name: FreeBSD (master) # skip-pr skip-stable
name: FreeBSD (stable) # skip-master skip-pr

on:
  pull_request: # skip-master skip-stable
    branches:   # skip-master skip-stable
      - "*"     # skip-master skip-stable
  push:         # skip-pr
    branches:   # skip-pr
      - master  # skip-pr skip-stable
      - stable  # skip-pr skip-master
  schedule: # skip-pr skip-stable
    - cron: "30 0 * * 1" # Every Monday at half past midnight UTC skip-pr skip-stable

jobs:
  build:
    name: Build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
        with:
          # v2 defaults to a shallow checkout, but we need at least to the previous tag
          fetch-depth: 0
      - uses: vmactions/freebsd-vm@v0.1.4
        id: test
        with:
          prepare: pkg install -y git gmake bash
          usesh: true
          run: |
            #
            echo "========="
            echo "Acquire tags for the repo"
            git fetch --no-tags --prune --depth=1 origin +refs/tags/*:refs/tags/*
            #
            echo "========="
            echo "Display the current git status"
            git status
            git describe
            #
            echo "========="
            echo "Prep cargo dirs"
            mkdir -p ~/.cargo/{registry,git}
            #
            echo "========="
            echo "Install Rustup using ./rustup-init.sh"
            sh rustup-init.sh --default-toolchain=stable --profile=minimal -y
            # source doesn't exist in this sh so instead it's "."
            . $HOME/.cargo/env
            #
            echo "========="
            echo "Ensure we have the components we need"
            rustup component add rustfmt
            rustup component add clippy
            #
            echo "========="
            echo "Run the freebsd check"
            unset SKIP_TESTS
            export LIBZ_SYS_STATIC=1
            export CARGO_BUILD_JOBS=1
            export TARGET="x86_64-unknown-freebsd"
            bash ci/run.bash
